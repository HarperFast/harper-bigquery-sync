#!/usr/bin/env sh

# Get the commit SHA and message
COMMIT_SHA=$(git rev-parse HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B)

# Process closed issues
if [ -f .git/CLOSED_ISSUES ]; then
  while read ISSUE_NUM; do
    echo "‚úÖ Marking issue #$ISSUE_NUM as done in TODO.md"

    # Update TODO.md to mark as completed
    if command -v sed > /dev/null; then
      # Mark the checkbox as done for this issue
      sed -i.bak "s/- \[ \] \*\*\(.*\)\*\* \[#$ISSUE_NUM\]/- [x] **\1** [#$ISSUE_NUM]/" TODO.md && rm TODO.md.bak 2>/dev/null
    fi

    # Comment on the GitHub issue
    if command -v gh > /dev/null; then
      gh issue comment "$ISSUE_NUM" --body "‚úÖ Completed in commit $COMMIT_SHA

$COMMIT_MSG" 2>/dev/null || echo "‚ö†Ô∏è  Could not comment on issue #$ISSUE_NUM (run 'gh auth login' if needed)"
    fi
  done < .git/CLOSED_ISSUES

  rm .git/CLOSED_ISSUES
fi

# Process updated issues
if [ -f .git/UPDATE_ISSUES ]; then
  while read ISSUE_NUM; do
    echo "üìù Commenting on issue #$ISSUE_NUM"

    if command -v gh > /dev/null; then
      gh issue comment "$ISSUE_NUM" --body "üìù Referenced in commit $COMMIT_SHA

$COMMIT_MSG" 2>/dev/null || echo "‚ö†Ô∏è  Could not comment on issue #$ISSUE_NUM"
    fi
  done < .git/UPDATE_ISSUES

  rm .git/UPDATE_ISSUES
fi

# If TODO.md was modified, stage it for the next commit
if git diff --name-only | grep -q "^TODO.md$"; then
  echo "üìã TODO.md was updated - stage it with 'git add TODO.md' to include in next commit"
fi

exit 0
